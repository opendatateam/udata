<style lang="less">
.resources-widget {
    .sort-placeholder {
        background: #C8EBFB !important;
    }

    .handle {
        cursor: move;
    }

    table.table {
        width:100%;
        table-layout:fixed;

        td.ellipsis {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    }

    .drop-active > & {
        border: 4px dashed #bbb;
        min-height: 150px;
    }

    .box-footer > button:not(:last-child) {
        margin-right: 10px;
    }
}
</style>

<template>
    <box title="{{ title }}" icon="file"
        boxclass="box-solid resources-widget"
        bodyclass="table-responsive no-padding"
        footerclass="text-center"
        footer="true" empty="{{ _('No resources') }}">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th v-if="reordering" width="30"></th>
                    <th v-i18n="Name"></th>
                    <th width="120" v-i18n="Format"></th>
                    <th width="100" v-i18n="Size"></th>
                    <th width="130" v-i18n="Downloads"></th>
                    <th width="100" v-i18n="Availability"></th>
                </tr>
            </thead>
            <tbody v-el="sortable">
                <tr v-repeat="file:files" track-by="id">
                    <td v-if="reordering"></td>
                    <td>
                        <div class="ellipsis">{{ file.name }}</div>
                        <div class="progress progress-xs progress-striped active">
                          <div class="progress-bar progress-bar-primary"
                            id="progress-{{file.id}}" style="width: 0%"></div>
                        </div>
                    </td>
                    <td>{{ file.type }}</td>
                    <td>{{ file.size | filesize }}</td>
                </tr>
                <tr v-repeat="resource:dataset.resources" v-on="click: display(resource)"
                    v-class="pointer: !reodering, move: reordering"
                    data-id="{{resource.id}}">
                    <td v-if="reordering" class="handle">
                        <span class="fa fa-bars"></span>
                    </td>
                    <td class="ellipsis">{{ resource.title }}</td>
                    <td>{{ resource.format }}</td>
                    <td>{{ resource.size | filesize }}</td>
                    <td class="text-center">
                        <span class="badge" v-class="
                            bg-green: resource.metrics.views > 0,
                            bg-red: (resource.metrics.views || 0) === 0
                            ">
                            {{ resource.metrics.views || 0 }}
                        </span>
                    </td>
                    <td class="text-center">
                        <span v-if="resource.is_available" class="badge bg-green">✓</span>
                        <span v-if="!resource.is_available" class="badge bg-red">×</span>
                    </td>
                </tr>
                <tr v-if="!(dataset && dataset.resources)" class="text-center lead">
                    <td colspan="3" v-i18n="No resources"></td>
                </tr>
            </tbody>
        </table>
        <div class="overlay dropzone" v-if="dropping">
            <span class="fa fa-download fa-2x"></span>
        </div>
        <footer>
            <button type="button"
                class="btn btn-primary btn-sm btn-flat pointer"
                v-show="!reordering"
                v-on="click: on_new">
                <span class="fa fa-fw fa-plus"></span>
                <span v-i18n="Add"></span>
            </button>
            <button type="button"
                class="btn btn-primary btn-sm btn-flat pointer"
                v-show="!reordering && dataset.resources && dataset.resources.length > 1"
                v-on="click: reorder">
                <span class="fa fa-fw fa-sort"></span>
                <span v-i18n="Reorder"></span>
            </button>
            <button type="button" class="btn btn-success btn-sm btn-flat pointer"
                v-show="reordering"
                v-on="click: reorder_done(true)">
                <span class="fa fa-fw fa-check"></span>
                <span v-i18n="Apply"></span>
            </button>
            <button type="button" class="btn btn-warning btn-sm btn-flat pointer"
                v-show="reordering"
                v-on="click: reorder_done(false)">
                <span class="fa fa-fw fa-times"></span>
                <span v-i18n="Cancel"></span>
            </button>
        </footer>
    </box>
</template>

<script>
'use strict';

var Vue = require('vue'),
    API = require('api'),
    endpoint = API.datasets.operations.upload_resource,
    Sorter = require('mixins/sorter'),
    Uploader = require('mixins/uploader'),
    Resource = require('models/resource');

module.exports = {
    name: 'resources-list',
    mixins: [Uploader, Sorter],
    components: {
        'box': require('components/containers/box.vue'),
        'pagination-widget': require('components/pagination.vue'),
    },
    data: function() {
        return {
            // title: Vue._('Resources'),
            // dropping: false
            dataset: {},
            reordering: false,
            new_order: []
        };
    },
    computed: {
        title: function() {
            return this.dropping ? Vue._('Drop resource') : Vue._('Resources');
        }
    },
    props: ['dataset'],
    events: {
        'uploader:progress': function(id, uploaded, total) {
            this.$find('#progress-' + id)
                .css('width',  Math.round(uploaded * 100 / total) + '%');
        },
        'uploader:complete': function(id, response) {
            var file = this.$uploader.getFile(id);
            this.files.$remove(this.files.indexOf(file));
            this.dataset.resources.unshift(response);
        }
    },
    ready: function() {
        /* In case of a new resource, we display the appropriated popin
           on load. */
        if ("new_resource" in this.$router.parameters) {
            this.on_new();
        }
    },
    methods: {
        on_new: function() {
            this.$root.$modal(
                {data: {dataset: this.dataset}},
                Vue.extend(require('components/dataset/resource/add-modal.vue'))
            );
        },
        reorder: function() {
            this.$sortable.option('disabled', false);
            this.$dnd.dispose();
            this.reordering = true;
            this._initial_order = this.$sortable.toArray();
        },
        reorder_done: function(toReorder) {
            this.$sortable.option('disabled', true);
            this.reordering = false;
            this.$dnd.setupExtraDropzone(this.$el);
            if (toReorder) {
                this.dataset.reorder(this.$sortable.toArray());
            } else {
                this.$sortable.sort(this._initial_order);
            }
        },
        display: function(resource) {
            if (!this.reordering) {
                this.$root.$modal(
                    {data: {
                        dataset: this.dataset,
                        resource: new Resource({data: resource})
                    }},
                    Vue.extend(require('components/dataset/resource/resource-modal.vue'))
                );
            }
        }
    },
    sortable: {
        disabled: true,
        draggable: 'tr',
        ghostClass: 'sort-placeholder',
    },
    watch: {
        'dataset.id': function(id) {
            if (id) {
                this.upload_endpoint = endpoint.urlify({dataset: id});
            }
        },
        "dataset.resources": function(resources) {
            /* If a `resource_id` is in the GET parameters we display the popin
               with the appropriated resource loaded. */
            if ("resource_id" in this.$router.parameters) {
                let resourceId = this.$router.parameters.resource_id;
                for (let resource of resources) {
                    if (resource.id === resourceId) {
                        this.display(resource);
                        break;
                    }
                }
            }
        }
    }
};
</script>
